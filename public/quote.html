<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote - De Facto Mobili</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #222;
            color: #FFF5D0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Loading & Error States */
        .loading { text-align: center; padding: 50px; }
        .loading-spinner { font-size: 40px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .error-box { background: #c53030; padding: 20px; border-radius: 10px; text-align: center; }
        
        /* Quote Header */
        .quote-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            padding-bottom: 15px; 
            border-bottom: 3px solid #BA3521; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .company-name { 
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 28px; 
            font-weight: 700; 
            letter-spacing: 2px;
        }
        .company-tagline { font-size: 10px; color: #999; letter-spacing: 2px; text-transform: uppercase; }
        .quote-info { text-align: right; }
        .quote-title { font-size: 22px; font-weight: 700; color: #F55139; }
        .quote-ref { font-size: 13px; color: #F55139; font-weight: 600; }
        .quote-date { font-size: 11px; color: #999; }
        
        /* Client Box */
        .client-box { 
            background: #333; 
            border-left: 4px solid #BA3521; 
            padding: 12px 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }
        .client-label { font-size: 9px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
        .client-name { font-size: 20px; font-weight: 700; }
        .client-phone { font-size: 13px; color: #999; margin-top: 3px; }
        
        /* Promo Bar */
        .promo-bar { 
            background: linear-gradient(135deg, #BA3521, #F55139); 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            margin-bottom: 15px; 
            font-weight: 700; 
            font-size: 14px; 
        }
        
        /* Section Title */
        .section-title { 
            font-size: 14px; 
            font-weight: 700; 
            color: #F55139; 
            border-bottom: 2px solid #BA3521; 
            padding-bottom: 6px; 
            margin-bottom: 10px; 
        }
        
        /* Detail Rows */
        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #444; 
            font-size: 13px; 
        }
        .detail-row span:last-child { font-weight: 600; }
        
        /* Material Box */
        .material-box { 
            background: #333; 
            border-left: 4px solid #F55139; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            text-align: center; 
        }
        .material-label { font-size: 12px; color: #999; margin-bottom: 3px; }
        .material-value { font-size: 28px; font-weight: 700; }
        
        /* Installation Box */
        .install-box { 
            background: linear-gradient(135deg, #1a4d3a, #0d3025); 
            border: 2px solid #38a169; 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            margin: 15px 0; 
        }
        .install-label { font-size: 12px; color: #68d391; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .install-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .install-original { font-size: 16px; color: #888; text-decoration: line-through; }
        .install-free { font-size: 28px; font-weight: 700; color: #68d391; }
        .install-badge { background: #38a169; color: white; padding: 4px 10px; border-radius: 15px; font-size: 10px; font-weight: 700; }
        .install-savings { background: rgba(56,161,105,0.3); border-radius: 6px; padding: 8px; margin-top: 10px; }
        .install-savings-label { font-size: 11px; color: #9ae6b4; }
        .install-savings-value { font-size: 20px; font-weight: 700; color: #FFF5D0; margin-top: 3px; }
        
        /* VAT Row */
        .vat-display { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            color: #999; 
            border-bottom: 1px solid #444; 
            font-size: 13px; 
        }
        
        /* Total Box */
        .total-display { 
            background: linear-gradient(135deg, #BA3521, #F55139); 
            border-radius: 10px; 
            padding: 20px; 
            margin: 15px 0; 
        }
        .total-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .total-label { font-size: 14px; }
        .total-value { font-size: 32px; font-weight: 700; }
        .total-savings-box { background: rgba(255,255,255,0.15); border-radius: 6px; padding: 10px; margin-top: 12px; text-align: center; }
        .total-savings-label { font-size: 11px; opacity: 0.9; }
        .total-savings-value { font-size: 20px; font-weight: 700; color: #90EE90; margin-top: 3px; }
        
        /* Footer */
        .quote-footer { 
            border-top: 3px solid #BA3521; 
            padding-top: 15px; 
            margin-top: 20px; 
            text-align: center; 
            color: #999; 
            font-size: 11px; 
            line-height: 1.6;
        }
        .quote-footer-brand { 
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 16px; 
            font-weight: 700; 
            color: #FFF5D0; 
            letter-spacing: 1px;
        }
        
        /* Action Buttons */
        .action-box { 
            background: #333; 
            border-radius: 12px; 
            padding: 25px; 
            margin-top: 30px; 
            text-align: center; 
        }
        .action-title { font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .btn { 
            display: block; 
            width: 100%; 
            padding: 18px; 
            border-radius: 10px; 
            font-size: 18px; 
            font-weight: 700; 
            text-decoration: none; 
            text-align: center; 
            border: none; 
            cursor: pointer; 
            margin-bottom: 10px; 
        }
        .btn-confirm { background: linear-gradient(135deg, #25D366, #128C7E); color: white; }
        .btn-pay { background: linear-gradient(135deg, #d69e2e, #b7791f); color: white; }
        .btn-print { background: #555; color: #FFF5D0; font-size: 14px; padding: 14px; margin-top: 15px; }
        .btn-help { font-size: 11px; color: #999; margin-top: 8px; }
        
        .confirmed-box { 
            background: #1a4d3a; 
            border: 2px solid #38a169; 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        .confirmed-text { color: #68d391; font-size: 16px; font-weight: 600; }
        
        .error-msg { 
            background: #742a2a; 
            border: 1px solid #c53030; 
            color: #feb2b2; 
            padding: 10px; 
            border-radius: 6px; 
            font-size: 12px; 
            margin-top: 10px; 
        }
        
        /* Print Styles - A4 Format */
        @media print {
            @page { 
                size: A4 portrait;
                margin: 10mm 15mm;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            html, body {
                width: 210mm;
                height: 297mm;
                background: #222 !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 11pt;
            }
            
            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .no-print { 
                display: none !important; 
            }
            
            .quote-header {
                border-bottom: 2px solid #BA3521 !important;
                padding-bottom: 10px !important;
                margin-bottom: 10px !important;
            }
            
            .company-name { font-size: 24pt !important; }
            .quote-title { font-size: 18pt !important; }
            
            .client-box {
                background: #333 !important;
                border-left: 3px solid #BA3521 !important;
                padding: 10px 12px !important;
                margin-bottom: 10px !important;
            }
            
            .client-name { font-size: 16pt !important; }
            
            .promo-bar {
                background: #BA3521 !important;
                padding: 10px !important;
                margin-bottom: 10px !important;
                font-size: 12pt !important;
            }
            
            .section-title {
                color: #F55139 !important;
                border-bottom: 2px solid #BA3521 !important;
                font-size: 12pt !important;
                margin-bottom: 8px !important;
            }
            
            .detail-row {
                padding: 6px 0 !important;
                font-size: 11pt !important;
            }
            
            .material-box {
                background: #333 !important;
                border-left: 3px solid #F55139 !important;
                padding: 12px !important;
                margin: 10px 0 !important;
            }
            
            .material-value { font-size: 22pt !important; }
            
            .install-box {
                background: #1a4d3a !important;
                border: 2px solid #38a169 !important;
                padding: 12px !important;
                margin: 10px 0 !important;
            }
            
            .install-free { font-size: 22pt !important; }
            .install-savings-value { font-size: 16pt !important; }
            
            .install-badge {
                background: #38a169 !important;
                color: white !important;
            }
            
            .install-savings {
                background: rgba(56,161,105,0.3) !important;
            }
            
            .total-display {
                background: #BA3521 !important;
                padding: 15px !important;
                margin: 10px 0 !important;
            }
            
            .total-value { font-size: 26pt !important; }
            .total-savings-value { font-size: 16pt !important; }
            
            .total-savings-box {
                background: rgba(255,255,255,0.2) !important;
            }
            
            .quote-footer {
                border-top: 2px solid #BA3521 !important;
                padding-top: 10px !important;
                margin-top: 15px !important;
            }
        }
        
        @media (max-width: 500px) {
            .quote-header { flex-direction: column; }
            .quote-info { text-align: left; }
            .total-value { font-size: 28px; }
            .material-value { font-size: 26px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="loading-spinner">‚è≥</div>
            <p style="margin-top: 15px;">Loading your quote...</p>
        </div>
        
        <!-- Error State -->
        <div class="error-box" id="errorState" style="display: none;">
            <h2>üòï Quote Not Found</h2>
            <p style="margin-top: 10px;">This quote may have expired or the link is invalid.</p>
            <p style="margin-top: 10px; font-size: 12px;">Please contact De Facto Mobili for assistance.</p>
        </div>
        
        <!-- Quote Content -->
        <div id="quoteContent" style="display: none;">
            <div class="quote-header">
                <div>
                    <div class="company-name">De Facto Mobili</div>
                    <div class="company-tagline">furniture and decoration</div>
                </div>
                <div class="quote-info">
                    <div class="quote-title">QUOTATION</div>
                    <div class="quote-ref" id="qRef">Ref: DFM-000000</div>
                    <div class="quote-date" id="qDate">00/00/0000 ‚Ä¢ Valid 7 days</div>
                </div>
            </div>
            
            <div class="client-box">
                <div class="client-label">Prepared For</div>
                <div class="client-name" id="qClientName">Client Name</div>
                <div class="client-phone" id="qClientPhone">üì± 0000000000</div>
            </div>
            
            <div class="promo-bar">‚ùÑÔ∏è WINTER HOLIDAY PROMOTION - FREE INSTALLATION! üéÅ</div>
            
            <div class="section-title">Wall Deco Panel Details</div>
            <div class="detail-row"><span>Panel Type</span><span id="qPanelType">Bas Relief</span></div>
            <div class="detail-row"><span>Total Area</span><span id="qArea">7 m¬≤</span></div>
            <div class="detail-row"><span>Price per m¬≤</span><span id="qPriceM2">AED 0.00</span></div>
            
            <div class="material-box">
                <div class="material-label">Material Price</div>
                <div class="material-value" id="qMaterial">AED 0.00</div>
            </div>
            
            <div class="install-box">
                <div class="install-label">üéâ Installation</div>
                <div class="install-row">
                    <span class="install-original" id="qInstallOrig">AED 5,950.00</span>
                    <span class="install-free">FREE</span>
                    <span class="install-badge">WINTER PROMO</span>
                </div>
                <div class="install-savings">
                    <div class="install-savings-label">You Save</div>
                    <div class="install-savings-value" id="qInstallSave">AED 5,950.00</div>
                </div>
            </div>
            
            <div class="vat-display" id="qVatRow">
                <span>VAT (5%)</span>
                <span id="qVat">AED 0.00</span>
            </div>
            
            <div class="total-display">
                <div class="total-row">
                    <div class="total-label">FINAL TOTAL</div>
                    <div class="total-value" id="qTotal">AED 0.00</div>
                </div>
                <div class="total-savings-box">
                    <div class="total-savings-label">üéÅ Your Savings with Winter Promo</div>
                    <div class="total-savings-value" id="qTotalSave">AED 0.00</div>
                </div>
            </div>
            
            <div class="quote-footer">
                <div>Prices in AED ‚Ä¢ VAT <span id="qVatText">included</span></div>
                <div class="quote-footer-brand">De Facto Mobili</div>
                <div>Dubai, UAE ‚Ä¢ furniture and decoration</div>
            </div>
            
            <div class="action-box no-print">
                <div id="confirmSection">
                    <div class="action-title">üì± Confirm Your Order</div>
                    <a class="btn btn-confirm" id="confirmBtn" href="#">‚úÖ CONFIRM THIS QUOTE</a>
                    <div class="btn-help">Tap to send confirmation via WhatsApp</div>
                </div>
                
                <div id="paySection" style="display: none;">
                    <div class="confirmed-box">
                        <div class="confirmed-text">‚úÖ Thank you for confirming!</div>
                    </div>
                    <a class="btn btn-pay" id="payBtn" href="#" target="_blank">üí≥ MAKE PAYMENT</a>
                    <div class="btn-help" id="payHelp">Secure payment via Telr ‚Ä¢ Visa / Mastercard / Apple Pay</div>
                    <div class="error-msg" id="payError" style="display: none;"></div>
                </div>
                
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
            </div>
        </div>
    </div>

<script>
// Store quote data globally
var quoteData = null;

// Get quote ID from URL
var params = new URLSearchParams(window.location.search);
var quoteId = params.get('id');

if (!quoteId) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
} else {
    // Fetch quote data
    fetch('/api/get-quote?id=' + encodeURIComponent(quoteId))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('loadingState').style.display = 'none';
            
            console.log('Quote data received:', data);
            
            if (data.success && data.quote) {
                quoteData = data.quote;
                showQuote(data.quote);
            } else {
                document.getElementById('errorState').style.display = 'block';
            }
        })
        .catch(function(e) {
            console.error('Error:', e);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        });
}

function showQuote(q) {
    document.getElementById('quoteContent').style.display = 'block';
    
    document.getElementById('qRef').textContent = 'Ref: ' + q.ref;
    document.getElementById('qDate').textContent = q.date + ' ‚Ä¢ Valid 7 days';
    document.getElementById('qClientName').textContent = q.clientName || 'Valued Customer';
    
    if (q.clientPhone) {
        document.getElementById('qClientPhone').textContent = 'üì± ' + q.clientPhone;
    } else {
        document.getElementById('qClientPhone').style.display = 'none';
    }
    
    document.getElementById('qPanelType').textContent = q.panelType;
    document.getElementById('qArea').textContent = q.area + ' m¬≤';
    document.getElementById('qPriceM2').textContent = q.priceM2;
    document.getElementById('qMaterial').textContent = q.material;
    document.getElementById('qInstallOrig').textContent = q.installOrig;
    document.getElementById('qInstallSave').textContent = q.installSave;
    
    if (q.vat && q.vat !== 'AED 0.00') {
        document.getElementById('qVat').textContent = q.vat;
        document.getElementById('qVatText').textContent = 'included';
    } else {
        document.getElementById('qVatRow').style.display = 'none';
        document.getElementById('qVatText').textContent = 'excluded';
    }
    
    document.getElementById('qTotal').textContent = q.total;
    document.getElementById('qTotalSave').textContent = q.installSave;
    
    // Debug: Log payment URL
    console.log('Payment URL from quote:', q.paymentUrl);
    
    // Setup pay button with amount
    var payBtn = document.getElementById('payBtn');
    payBtn.textContent = 'üí≥ MAKE PAYMENT - ' + q.total;
    
    if (q.paymentUrl && q.paymentUrl.length > 10) {
        payBtn.href = q.paymentUrl;
        payBtn.target = '_blank';
        console.log('Payment button href set to:', q.paymentUrl);
    } else {
        // No valid payment URL - show error and still allow button click to generate one
        console.log('No valid payment URL found');
        document.getElementById('payError').textContent = 'Payment link not available. Please contact De Facto Mobili.';
        document.getElementById('payError').style.display = 'block';
        payBtn.style.opacity = '0.6';
        payBtn.onclick = function(e) {
            e.preventDefault();
            alert('Payment link is not available. Please contact De Facto Mobili to complete your payment.');
        };
    }
    
    // Check if already confirmed (using localStorage)
    var isConfirmed = false;
    try {
        isConfirmed = localStorage.getItem('confirmed_' + q.ref) === 'true';
    } catch(e) {}
    
    // Setup confirm button
    if (q.senderPhone && !isConfirmed) {
        var msg = encodeURIComponent('‚úÖ QUOTE CONFIRMED\n\nRef: ' + q.ref + '\nClient: ' + (q.clientName || 'Customer') + '\nPanel: ' + q.panelType + '\nArea: ' + q.area + ' m¬≤\nTotal: ' + q.total + '\n\nI confirm and want to proceed with the order.');
        document.getElementById('confirmBtn').href = 'https://wa.me/' + q.senderPhone + '?text=' + msg;
        
        document.getElementById('confirmBtn').onclick = function() {
            // Store confirmation in localStorage
            try {
                localStorage.setItem('confirmed_' + q.ref, 'true');
            } catch(e) {}
            
            // Show pay section after a short delay
            setTimeout(function() {
                document.getElementById('confirmSection').style.display = 'none';
                document.getElementById('paySection').style.display = 'block';
            }, 500);
        };
    } else {
        // Already confirmed or no sender phone - show pay section directly
        document.getElementById('confirmSection').style.display = 'none';
        document.getElementById('paySection').style.display = 'block';
    }
}
</script>
</body>
</html>
